{% extends "base.html" %}

{% block content %}
<div class="mb-4 d-flex justify-content-between align-items-center">
  <h3 class="fw-bold"><i class="bi bi-graph-up"></i> Dashboard Geral</h3>
  <form method="POST" class="row g-2">
    <div class="col">
      <select class="form-select" name="selecao" id="selecaoSecao" onchange="exibirSecao()">
        <option value="">Exibir Tudo</option>
        <option value="secao-alertas">Alertas</option>
        <option value="secao-indicadores">Indicadores</option>
        <option value="secao-financeiro">Financeiro</option>
        <option value="secao-graficos">Gr√°ficos</option>
        <option value="secao-revisoes">Revis√µes / Inspe√ß√µes</option>
        <option value="secao-alugados">Ve√≠culos Alugados</option>
        <option value="secao-clientes">√öltimos Clientes</option>
        <option value="secao-tipo-categoria">Tipo e Categoria</option>
      </select>
    </div>
    <div class="col-auto">
      <a href="{{ url_for('exportar_tudo', formato='xlsx') }}" class="btn btn-outline-success">
        <i class="bi bi-download"></i> Exportar
      </a>
    </div>
  </form>
</div>

<!-- üîî ALERTAS -->
<div id="secao-alertas">
  <div class="row text-center mb-4">
    {% if vencidas %}
    <div class="col-md-6 mb-3">
      <div class="card border-danger shadow-sm p-3">
        <h5 class="text-danger"><i class="bi bi-exclamation-triangle-fill"></i> Revis√µes Vencidas</h5>
        <h1 class="text-danger">{{ vencidas | length }}</h1>
      </div>
    </div>
    {% endif %}
    {% if proximas %}
    <div class="col-md-6 mb-3">
      <div class="card border-warning shadow-sm p-3">
        <h5 class="text-warning"><i class="bi bi-hourglass-split"></i> Revis√µes em 5 Dias</h5>
        <h1 class="text-warning">{{ proximas | length }}</h1>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- üî¢ INDICADORES -->
<div id="secao-indicadores">
  <div class="row text-center mb-4">
    <div class="col-md-4 mb-3">
      <div class="card text-bg-primary shadow-sm p-3">
        <h5><i class="bi bi-truck-front"></i> Ve√≠culos</h5>
        <h2>{{ total_veiculos }}</h2>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card text-bg-success shadow-sm p-3">
        <h5><i class="bi bi-calendar-check"></i> Reservas</h5>
        <h2>{{ total_reservas }}</h2>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card text-bg-warning shadow-sm p-3">
        <h5><i class="bi bi-tools"></i> Manuten√ß√µes</h5>
        <h2>{{ total_manutencoes }}</h2>
      </div>
    </div>
  </div>
</div>

<!-- üí∞ FINANCEIRO -->
<div id="secao-financeiro">
  <div class="row text-center mb-4">
    <div class="col-md-6 mb-3">
      <div class="card text-bg-dark shadow-sm p-3">
        <h5><i class="bi bi-calendar3"></i> Reservas no M√™s</h5>
        <h2>{{ total_reservas_mes }}</h2>
      </div>
    </div>
    <div class="col-md-6 mb-3">
      <div class="card text-bg-dark shadow-sm p-3">
        <h5><i class="bi bi-currency-dollar"></i> Financeiro Confirmado</h5>
        <h2>R$ {{ '%.2f' | format(total_financeiro_mes) }}</h2>
      </div>
    </div>
  </div>
</div>

<!-- üìä GR√ÅFICOS -->
<div id="secao-graficos">
  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card p-3 shadow-sm">
        <h5 class="text-center">Reservas por Ve√≠culo</h5>
        <img src="{{ grafico_reservas }}" class="img-fluid" alt="Gr√°fico de Reservas">
      </div>
    </div>
    <div class="col-md-6 mb-4">
      <div class="card p-3 shadow-sm">
        <h5 class="text-center">Manuten√ß√µes por Ve√≠culo</h5>
        <img src="{{ grafico_manutencao }}" class="img-fluid" alt="Gr√°fico de Manuten√ß√µes">
      </div>
    </div>
  </div>
</div>

<!-- üîç REVIS√ïES -->
<div id="secao-revisoes">
  <div class="card mt-5">
    <div class="card-header bg-warning text-dark">
      <h5><i class="bi bi-tools"></i> Revis√µes e Inspe√ß√µes a Vencer</h5>
    </div>
    <div class="card-body">
      {% if veiculos_alerta %}
      <table class="table table-bordered text-center align-middle">
        <thead class="table-secondary">
          <tr>
            <th>Modelo</th>
            <th>Placa</th>
            <th>Pr√≥xima Revis√£o</th>
            <th>Inspe√ß√£o</th>
          </tr>
        </thead>
        <tbody>
          {% for v in veiculos_alerta %}
          <tr>
            <td>{{ v.modelo }}</td>
            <td>{{ v.placa }}</td>
            <td>{{ v.proxima_revisao or "-" }}</td>
            <td>{{ v.inspecao or "-" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-muted">Nenhum ve√≠culo com revis√£o ou inspe√ß√£o pr√≥xima.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- üöó VE√çCULOS ALUGADOS -->
<div id="secao-alugados">
  <h4 class="mt-4"><i class="bi bi-clock-history"></i> Ve√≠culos Alugados</h4>
  <table class="table table-bordered align-middle text-center">
    <thead class="table-secondary">
      <tr>
        <th>Modelo</th>
        <th>Cliente</th>
        <th>Data de Devolu√ß√£o</th>
        <th>Dias Restantes</th>
      </tr>
    </thead>
    <tbody>
      {% for v in veiculos_alugados %}
      <tr>
        <td>{{ v[0] }}</td>
        <td>{{ v[1] }}</td>
        <td>{{ v[2] }}</td>
        <td>{{ v[3] }} dias</td>
      </tr>
      {% else %}
      <tr>
        <td colspan="4" class="text-muted">Nenhum ve√≠culo alugado.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- üë• √öLTIMOS CLIENTES -->
<div id="secao-clientes">
  <div class="card mt-4">
    <div class="card-header bg-secondary text-white">
      <h5>√öltimos Clientes</h5>
    </div>
    <div class="card-body">
      {% if ultimos_clientes %}
      <ul class="list-group">
        {% for cliente in ultimos_clientes %}
        <li class="list-group-item">
          <strong>{{ cliente[0] }}</strong> - {{ cliente[1] }} | {{ cliente[2] }}
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-muted">Nenhum cliente encontrado.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- üöô TIPO E CATEGORIA -->
<div id="secao-tipo-categoria" class="mt-5">
  <div class="row">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
          <h5><i class="bi bi-car-front"></i> Ve√≠culos por Tipo</h5>
        </div>
        <div class="card-body">
          {% if not veiculos_por_tipo.empty %}
          <ul class="list-group">
            {% for index, row in veiculos_por_tipo.iterrows() %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ row.tipo }}
              <span class="badge bg-primary rounded-pill">{{ row.total }}</span>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="text-muted">Nenhum tipo encontrado.</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5><i class="bi bi-tags"></i> Ve√≠culos por Categoria</h5>
        </div>
        <div class="card-body">
          {% if not veiculos_por_categoria.empty %}
          <ul class="list-group">
            {% for index, row in veiculos_por_categoria.iterrows() %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ row.categoria }}
              <span class="badge bg-success rounded-pill">{{ row.total }}</span>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="text-muted">Nenhuma categoria encontrada.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function exibirSecao() {
    const secaoSelecionada = document.getElementById("selecaoSecao").value;
    const secoes = [
      "secao-alertas", "secao-indicadores", "secao-financeiro",
      "secao-graficos", "secao-revisoes", "secao-alugados",
      "secao-clientes", "secao-tipo-categoria"
    ];
    secoes.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.style.display = secaoSelecionada === "" || secaoSelecionada === id ? "block" : "none";
      }
    });
  }
  window.onload = exibirSecao;
</script>
{% endblock %}
